<!DOCTYPE html>
<html lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Linux服务器安全策略 - 小V吃鱼卡到了</title>
    <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico">
    <link rel="stylesheet" href="http://www.zhuimengle.com/theme/css/bootstrap.min.css" type="text/css" />
    <link rel="stylesheet" href="//netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.min.css" type="text/css" />
    <link rel="stylesheet" href="http://www.zhuimengle.com/theme/css/niu2.min.css" type="text/css" />

    <link rel="canonical" href="http://www.zhuimengle.com/note/linux_host-security.html" />
    
    <script type="text/javascript">window.onload=function(){};</script>
    <!--[if lt IE 9]>
        <script src="http://www.zhuimengle.com/theme/js/html5shiv.js"></script>
        <script src="http://www.zhuimengle.com/theme/js/respond.min.js"></script>
    <![endif]-->
  </head>
  <body> 
    <div id="body-header">
<div class="navbar navbar-inverse navbar-fixed-top">
<div class="col-md-12">
    <div class="navbar-header">
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="http://www.zhuimengle.com">
            <i class="fa fa-home"></i>小V吃鱼卡到了
        </a>
    </div>
    <nav class="collapse navbar-collapse bs-navbar-collapse" role="navigation">
        <ul class="nav navbar-nav">
            <li><a href="/about.html" title="about me">
                <i class="fa fa-anchor"></i>关于</a>
            </li>
            <li><a href="/agreement.html" title="agreement">
                <i class="fa fa-info-circle"></i>使用协议</a>
            </li>
            <li><a href="/my_projects.html" title="my projects">
                <i class="fa fa-rocket"></i>项目</a>
            </li>
            <li><a href="/archives.html" title="blog archives">
                <i class="fa fa-archive"></i>存档</a>
            </li>
            <li><a href="/tag/" title="blog tags">
                <i class="fa fa-tag"></i>标签</a>
            </li>
        <!-- category dropdown list -->
        <li class="dropdown">
           <a href="#" class="dropdown-toggle" data-toggle="dropdown">
                <i class="fa fa-folder-open"></i>分类<b class="caret"></b>
           </a>
           <ul class="dropdown-menu">
               <li><a href="http://www.zhuimengle.com/note/index.html">
                      <i class="fa fa-book"></i>印象-笔记
                      (88)</a></li>
               <li><a href="http://www.zhuimengle.com/research/index.html">
                      <i class="fa fa-flask"></i>实验室
                      (2)</a></li>
           </ul>
        </li>
        <!--  self defined dropdown list -->
        </ul>
        
        <!-- right nav bar -->
        <ul class="nav navbar-nav navbar-right">
        <!-- google custom search -->
       </ul>
    </nav>
</div>
</div>    </div>
    
    <div id="body-content">
<div class="col-md-8 col-md-offset-2">
    <h1 id="content-heading">Linux服务器安全策略</h1>
</div>
<div id="niu2-left-container" class="col-md-6 col-md-offset-2 with-right-border">
    <div id="niu2-main-content">
        <p>记录网站安全策略, 主要参考<a href="http://library.linode.com/securing-your-server">Linode的文档</a>写成。</p>
<h2 id="7fde08ae873de355460f8efd88c0d139">添加sudo用户</h2>
<p>安装sudo</p>
<div class="codehilite"><pre>apt-get install sudo
</pre></div>


<p>创建新用户并将其加入sudo组</p>
<div class="codehilite"><pre>adduser your_user_name
usermod -a -G sudo your_user_name
</pre></div>


<p>然后注销当前登录并使用新的用户名登录.</p>
<h2 id="81b946c715e023cc04458d7aeae15546">ssh配置</h2>
<h3 id="834c63a2df1787d1182d9defc9a590f0">生成Key</h3>
<p>生成ssh公钥和密钥, 默认位于~/.ssh/</p>
<div class="codehilite"><pre>ssh-keygen -C your_comment
</pre></div>


<p><code>~/.ssh/authorized_keys</code>用于保存已验证的公钥, 因此必须确认~/.ssh文件夹和~/.ssh/authorized_keys文件不能被其他用户访问.</p>
<div class="codehilite"><pre>chown -R your_user_name:your_user_name ~/.ssh
chmod 700 ~/.ssh
chmod 600 ~/.ssh/authorized_keys
</pre></div>


<p>将你的公钥添加到服务器的<code>~/.ssh/authorized_keys</code>中, 这样不用密码即可登录.</p>
<h3 id="d936d0fe4f8d946c86e961b7ebe1dc78">修改默认监听端口</h3>
<p>假设新端口为7788，首先使用netstat命令查看该端口是否已被占用:</p>
<div class="codehilite"><pre>sudo netstat -nap | grep 7788
</pre></div>


<p>若7788还未被使用，则修改<code>/etc/ssh/sshd_config</code>，将 <code>Port 22</code>改为<code>Port 7788</code> 重启ssh服务即可:</p>
<div class="codehilite"><pre>sudo service ssh restart
</pre></div>


<p>最后记得为新的端口添加iptables规则，参考<a href="#iptables">#iptables</a>，在<code>/etc/iptables.firewall.rules</code>中将 <code>-A INPUT -p tcp -m state --state NEW --dport 22 -j ACCEPT</code> 改为 <code>-A INPUT -p tcp -m state --state NEW --dport 59581 -j ACCEPT</code>
然后使用<code>iptables-restore &lt; /etc/iptables.firewall.rules</code>导入新的规则。这样即可禁用22端口，并开启59581端口。</p>
<h3 id="99fe621a21976e89fe0870048cd5c12e">禁止使用密码登录，禁止root用户登录</h3>
<p>修改<code>/etc/ssh/sshd_config</code>文件, 修改或添加如下几行:</p>
<div class="codehilite"><pre>PasswordAuthentication no
PermitRootLogin no
</pre></div>


<p>保存后重启ssh服务</p>
<div class="codehilite"><pre>sudo service ssh restart
</pre></div>


<h2 id="451431639718b9daf01759a121a420c5">日志监控</h2>
<h3 id="e704bc6633d4196d31bb47f6b2d9ccca">denyhosts</h3>
<p>denyhosts通过分析<code>/var/log/auth.log</code>来将某些非正常的ip添加到<code>/etc/hosts.deny</code>中，可通过如下命令安装。</p>
<div class="codehilite"><pre>sudo apt-get install denyhosts
</pre></div>


<p>配置文件位于<code>/etc/denyhosts.conf</code></p>
<p>如果自己的电脑ssh连接时出现类似下面这样的错误：</p>
<div class="codehilite"><pre>ssh_exchange_identification: Connection closed by remote host
</pre></div>


<p>那基本能确定是denyhosts将你的ip添加到了<code>/etc/hosts.deny</code>中<sup id="fnref:1"><a class="footnote-ref" href="#fn:1" rel="footnote">1</a></sup>。为避免类似的情况，可以将自己的ip添加到<code>/etc/hosts.allow</code>中。</p>
<h3 id="8bb605fe300d1d800768bce7bcec114f">logwatch</h3>
<p>logwatch分析系统日志, 并提取重要的信息发到你的邮箱里, 通过如下命令安装:</p>
<div class="codehilite"><pre>sudo apt-get install logwatch
</pre></div>


<p>拷贝配置文件</p>
<div class="codehilite"><pre>sudo cp /usr/share/logwatch/default.conf/logwatch.conf /etc/logwatch/logwatch.conf
</pre></div>


<p>修改<code>/etc/logwatch/logwatch.conf</code>:</p>
<div class="codehilite"><pre>Output = mail                # 发送邮件 
Format = html                # 生成html格式的报告
MailTo = your_email_address  # 定义你的邮箱地址
</pre></div>


<p>运行<code>logwatch</code>命令, 稍等片刻后检查是否收到logwatch的邮件. 如果一切正常则可以把logwatch添加到cron计划任务中让其自动运行. (debian6上logwatch默认自动加入cron任务, 检查<code>/etc/cron.daily/00logwatch</code>), 如果无法收到邮件, 请检查服务器的邮件发送配置, 可参考<a href="./build_linux_host#邮件设置">这里</a>的相关配置.</p>
<h2 id="8606f66d0bcb4cc1983e1a85adbcd253">防火墙</h2>
<h3 id="46fd47ed4524abd528fbebe9ea485c8f">用Tcp Wrappers控制服务访问</h3>
<p>使用logwatch后，经常发现某些ip会暴力猜解ssh密码，对某些烦人的IP，可以使用Tcp Wrappers限制其对某些服务的访问。</p>
<p><code>/etc/hosts.allow</code>和<code>/etc/hosts.deny</code>两个文件用于控制远端对某些服务的访问，但必须注意的是，通常只有两类服务可以被<code>/etc/hosts.allow</code>和<code>/etc/hosts.deny</code>限制:</p>
<ol>
<li>由tcpwrapper服务(tcpd)启动的服务，需要安装xinetd软件，并在<code>/etc/xinetd.conf</code>和<code>/etc/xinetd.d/*</code>进行相应的设置。</li>
<li>编译时即添加了libwrapper库支持的服务，使用<code>apt-cache rdepends libwrap0</code>查看所有内置支持librwapper的软件。</li>
</ol>
<p>这里仅介绍第二类情况的配置方法，多数系统服务默认使用此种方法使用Tcp Wrappers。如果想查看某个服务是否内置支持libwrapper，则可以使用如下方法。以sshd为例，使用如下命令查看某个服务是否使用tcpwrappers库:</p>
<div class="codehilite"><pre>ldd /usr/sbin/sshd | grep libwrap
</pre></div>


<p>如果输出结果包含<code>libwrap.so</code>或<code>libwrap.so.0</code>，则表示ssh使用了tcpwrappers库。</p>
<p>对于以上两种服务，我们可以用<code>/etc/hosts.deny</code>限制远程访问。<code>/etc/hosts.allow</code>和<code>/etc/hosts.deny</code>的语法，可以使用<code>man 5 hosts_access</code>和<code>man 5 hosts_options</code>查看，下面做简要介绍:</p>
<div class="codehilite"><pre>&lt;daemon list&gt;:&lt;client list&gt;[:&lt;option&gt;:&lt;option&gt;:...]
</pre></div>


<p>其中</p>
<div class="codehilite"><pre>? daemon list 
:逗号或空格(tab)分隔的服务列表，或ALL通配符。
? client list 
:逗号或空格(tab)分隔的host或ip列表。
? option 
: 其他选项。
</pre></div>


<p>所以，如果要禁止ip为x.x.x.x的用户访问所有服务，可以在<code>/etc/hosts.deny</code>里添加如下一行:</p>
<div class="codehilite"><pre>ALL: x.x.x.x
</pre></div>


<p>需要注意的是，<code>/etc/hosts.allow</code>比<code>/etc/hosts.deny</code>拥有更高的优先级，即当两个文件里定义了同样的规则时，以<code>/etc/hosts.allow</code>为准。</p>
<h3 id="83090a9f3b90125d95e92dec20df9817">iptables</h3>
<p>学习iptables配置的最好方法是阅读<a href="http://www.netfilter.org/documentation/">iptables的文档</a>.</p>
<h4 id="f55f69d1e6a6700ea122f4760a92c312">安装iptables-persistent软件包</h4>
<p>安装iptables-persistent后, 将iptables配置文件放在<code>/etc/iptables/rules</code>即可实现开机自动导入iptables规则. 修改该配置文件后执行<code>service iptables-persistent start</code>即可使用iptables-restore重新加载<code>/etc/iptables/rules</code>.</p>
<h4 id="b5f73bfbb7e9045b95c1fc98145d0f43">我的iptables配置文件</h4>
<p>注意, 使用时需要将下面三行中的$PORT变量改为你的实际端口号:</p>
<div class="codehilite"><pre>-A INPUT -p tcp --dport $YOUR_HTTP_PORT -j ACCEPT
-A INPUT -p tcp --dport $YOUR_HTTPS_PORT -j ACCEPT
-A INPUT -p tcp -m state --state NEW --dport $YOUR_SSHD_PORT -j ACCEPT
</pre></div>


<p>然后将下面一行中的$YOUR_IP改为你的IP地址:</p>
<div class="codehilite"><pre>-A INPUT -s $YOUR_IP -j ACCEPT
</pre></div>


<p>下面是我的<code>/etc/iptables/rules</code>:</p>
<div class="codehilite"><pre># filter表规则

*filter
#  Allow all loopback (lo0) traffic and drop all traffic to 127/8 that doesn&#39;t use lo0
-A INPUT -i lo -j ACCEPT
-A INPUT -d 127.0.0.0/8 -j REJECT

#  Accept all established inbound connections
-A INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT

#  Allow all outbound traffic - you can modify this to only allow certain traffic
-A OUTPUT -j ACCEPT

#  Allow HTTP and HTTPS connections from anywhere (the normal ports for websites and SSL).
-A INPUT -p tcp --dport $YOUR_HTTP_PORT -j ACCEPT
-A INPUT -p tcp --dport $YOUR_HTTPS_PORT -j ACCEPT

#  Allow SSH connections
#  The -dport number should be the same port number you set in sshd_config
-A INPUT -p tcp -m state --state NEW --dport $YOUR_SSHD_PORT -j ACCEPT

#  Allow ping
-A INPUT -p icmp -j ACCEPT

#  Log iptables denied calls
-A INPUT -m limit --limit 5/min -j LOG --log-prefix &quot;iptables denied: &quot; --log-level 7

# Allow to create new pptp connections
-A INPUT -p tcp --dport 1723 -m state --state NEW -j ACCEPT

# Enable forward for pptpd
-A FORWARD -s 192.168.0.0/24 -j ACCEPT
-A FORWARD -d 192.168.0.0/24 -j ACCEPT

# Allow input for my ips
-A INPUT -s $YOUR_IP -j ACCEPT

#  Drop all other inbound - default deny unless explicitly allowed policy
-A INPUT -j DROP
-A FORWARD -j DROP 
COMMIT

# nat表规则

*nat 
# for pptpd

-A POSTROUTING -s 192.168.0.0/24 -o eth0 -j MASQUERADE 
COMMIT
</pre></div>


<h4 id="910a27da15d2376aacc022bbdff0a5d2">unable to initialize table filter</h4>
<p>安装<code>xtables-addons-common</code>即可。</p>
<h2 id="81f5d554d30e82d475ed29a45a7c4277">阅读资料</h2>
<ul>
<li><a href="http://library.linode.com/securing-your-server">Securing your server</a> from linode documentation</li>
<li><a href="http://library.linode.com/security/firewalls/iptables">Control Network Traffic with iptables</a> from linode documentation  </li>
<li><a href="http://www.debian.org/doc/manuals/securing-debian-howto/ch4.en.html">Securing debian howto</a></li>
<li><a href="http://ubuntu-tutorials.com/2007/09/02/network-security-with-tcpwrappers-hostsallow-and-hostsdeny/">Network Security with tcpwrappers (hosts.allow and hosts.deny)</a></li>
<li><a href="http://www.linuxhomenetworking.com/wiki/index.php/Quick_HOWTO_:_Ch14_:_Linux_Firewalls_Using_iptables">Quick HOWTO : Ch14 : Linux Firewalls Using iptables</a></li>
<li><a href="http://wiki.debian.org/iptables">Debian iptables wiki</a></li>
<li><a href="http://www.netfilter.org/documentation/">Iptables docuemntation</a></li>
</ul>
<div class="footnote">
<hr />
<ol>
<li id="fn:1">
<p>参考<a href="https://www.linode.com/wiki/index.php/Ssh_exchange_identification:_Connection_closed_by_remote_host">Ssh exchange identification: Connection closed by remote host</a>，引用于2014-03-10。&#160;<a class="footnote-backref" href="#fnref:1" rev="footnote" title="Jump back to footnote 1 in the text">&#8617;</a></p>
</li>
</ol>
</div>
    </div>
    <div id="content-comments">
<!-- Duoshuo Comment BEGIN -->
<div class="ds-thread"></div>
<script type="text/javascript">var duoshuoQuery={short_name:"vic-story"};(function(){var a=document.createElement("script");a.type="text/javascript";a.async=true;a.src=(document.location.protocol=="https:"?"https:":"http:")+"//static.duoshuo.com/embed.js";a.charset="UTF-8";(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(a)})();</script>
<!-- Duoshuo Comment END --></div>

</div>
<div class="niu2-right-container col-md-2">
    <div id="niu2-sidebar-meta" class="niu2-sidebar">
        <div class="niu2-sidebar-label"><i class="fa fa-calendar"></i>发布时间:</div>
        <div class="niu2-sidebar-value">2013-08-08 12:14</div>
        <div class="niu2-sidebar-label"><i class="fa fa-pencil" style="font-size: 1.05em;"></i>最后修改:</div>
        <div class="niu2-sidebar-value">2014-03-10 12:21</div>
        <div class="niu2-sidebar-label"><i class="fa fa-book"></i>分类:</div>
        <div class="niu2-sidebar-value"><a href="http://www.zhuimengle.com/note/index.html">印象-笔记</a></div>
        <div class="niu2-sidebar-label"><i class="fa fa-tag"></i>标签:</div>
 
            <div class="niu2-sidebar-inter-value niu2-sidebar-tag"><a href="http://www.zhuimengle.com/tag/linux_server.html">linux_server</a><sup>3</sup></div>
            <div class="niu2-sidebar-inter-value niu2-sidebar-tag"><a href="http://www.zhuimengle.com/tag/security.html">security</a><sup>3</sup></div>
    </div>
</div>

<div class="niu2-right-container col-md-3">
    <div id="niu2-sidebar-toc" class="niu2-sidebar" data-status="closed">
        <div class="niu2-sidebar-label">
            <i id="niu2-sidebar-toc-ctrl" class="fa fa-plus"></i>目录
        </div>
        <ol id="niu2-sidebar-toc-list">
            <li><a href="#content-heading">Linux服务器安全策略</a></li>
            <li><a href='#7fde08ae873de355460f8efd88c0d139'>添加sudo用户</a></li><li><a href='#81b946c715e023cc04458d7aeae15546'>ssh配置</a><ol><li><a href='#834c63a2df1787d1182d9defc9a590f0'>生成Key</a></li><li><a href='#d936d0fe4f8d946c86e961b7ebe1dc78'>修改默认监听端口</a></li><li><a href='#99fe621a21976e89fe0870048cd5c12e'>禁止使用密码登录，禁止root用户登录</a></li></ol></li><li><a href='#451431639718b9daf01759a121a420c5'>日志监控</a><ol><li><a href='#e704bc6633d4196d31bb47f6b2d9ccca'>denyhosts</a></li><li><a href='#8bb605fe300d1d800768bce7bcec114f'>logwatch</a></li></ol></li><li><a href='#8606f66d0bcb4cc1983e1a85adbcd253'>防火墙</a><ol><li><a href='#46fd47ed4524abd528fbebe9ea485c8f'>用Tcp Wrappers控制服务访问</a></li><li><a href='#83090a9f3b90125d95e92dec20df9817'>iptables</a><ol><li><a href='#f55f69d1e6a6700ea122f4760a92c312'>安装iptables-persistent软件包</a></li><li><a href='#b5f73bfbb7e9045b95c1fc98145d0f43'>我的iptables配置文件</a></li><li><a href='#910a27da15d2376aacc022bbdff0a5d2'>unable to initialize table filter</a></li></ol></li></ol></li><li><a href='#81f5d554d30e82d475ed29a45a7c4277'>阅读资料</a></li>
            <li><a href="#content-comments">评论</a></li>
        </ol>
    </div>
</div>
    </div>

    <div id="body-footer" class="col-md-6 col-md-offset-2">
<div class="niu2-footer">
    <hr/>
	<p>
		Powered by <a href="https://github.com/getpelican/pelican">Pelican</a>, 
        <a href="https://github.com/mawenbao/niu-x2-sidebar">theme</a> built with <a href="http://getbootstrap.com">Bootstrap3</a>
		by <a href="http://blog.atime.me">Ma Wenbao</a>, icons by 
		<a href="http://fortawesome.github.io/Font-Awesome">Font Awesome</a>.
	</p>
	<p>
		©
				2009-2014
		<a class="niu2-footer-link" href="http://www.zhuimengle.com">vk</a>
    </p>
    <p class="niu2-icons">
	        <a class="niu2-footer-icon" href="/my_gnupg.html" title="my public key">
	            <i class="fa fa-key fa-lg"></i>
	        </a>
	        <a class="niu2-footer-icon" href="V: dolphinzhang1987@gmail.com" title="my email address">
	            <i class="fa fa-envelope-o fa-lg"></i>
	        </a>
	        <a class="niu2-footer-icon" href="https://github.com/vickyi" title="my github page">
	            <i class="fa fa-github-alt fa-lg"></i>
	        </a>
	        <a class="niu2-footer-icon" href="/feed.xml" title="subscribe my blog">
	            <i class="fa fa-rss fa-lg"></i>
	        </a>
	</p>
</div>    </div>
    
    <div id="niu2-pygments" data-theme="github"></div>

    <script type="text/javascript" src="//ajax.aspnetcdn.com/ajax/jQuery/jquery-1.11.0.min.js"></script>
    <script type="text/javascript" src="http://www.zhuimengle.com/theme/js/niu2.min.js"></script>
    <script type="text/javascript" src="http://www.zhuimengle.com/theme/js/bootstrap.min.js"></script>
    <script type="text/javascript">onContentLoaded();</script>
  </body>
</html>