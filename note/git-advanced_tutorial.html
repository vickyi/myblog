<!DOCTYPE html>
<html lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Git进阶教程 - 小V吃鱼卡到了</title>
    <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico">
    <link rel="stylesheet" href="http://www.zhuimengle.com/theme/css/bootstrap.min.css" type="text/css" />
    <link rel="stylesheet" href="//netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.min.css" type="text/css" />
    <link rel="stylesheet" href="http://www.zhuimengle.com/theme/css/niu2.min.css" type="text/css" />

    <link rel="canonical" href="http://www.zhuimengle.com/note/git-advanced_tutorial.html" />
    
    <script type="text/javascript">window.onload=function(){};</script>
    <!--[if lt IE 9]>
        <script src="http://www.zhuimengle.com/theme/js/html5shiv.js"></script>
        <script src="http://www.zhuimengle.com/theme/js/respond.min.js"></script>
    <![endif]-->
  </head>
  <body> 
    <div id="body-header">
<div class="navbar navbar-inverse navbar-fixed-top">
<div class="col-md-12">
    <div class="navbar-header">
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="http://www.zhuimengle.com">
            <i class="fa fa-home"></i>小V吃鱼卡到了
        </a>
    </div>
    <nav class="collapse navbar-collapse bs-navbar-collapse" role="navigation">
        <ul class="nav navbar-nav">
            <li><a href="/about.html" title="about me">
                <i class="fa fa-anchor"></i>关于</a>
            </li>
            <li><a href="/archives.html" title="blog archives">
                <i class="fa fa-archive"></i>存档</a>
            </li>
            <li><a href="/tag/" title="blog tags">
                <i class="fa fa-tag"></i>标签</a>
            </li>
        <!-- category dropdown list -->
        <li class="dropdown">
           <a href="#" class="dropdown-toggle" data-toggle="dropdown">
                <i class="fa fa-folder-open"></i>分类<b class="caret"></b>
           </a>
           <ul class="dropdown-menu">
               <li><a href="http://www.zhuimengle.com/note/index.html">
                      <i class="fa fa-book"></i>印象-笔记
                      (88)</a></li>
               <li><a href="http://www.zhuimengle.com/research/index.html">
                      <i class="fa fa-flask"></i>实验室
                      (2)</a></li>
           </ul>
        </li>
        <!--  self defined dropdown list -->
        </ul>
        
        <!-- right nav bar -->
        <ul class="nav navbar-nav navbar-right">
        <!-- google custom search -->
       </ul>
    </nav>
</div>
</div>    </div>
    
    <div id="body-content">
<div class="col-md-8 col-md-offset-2">
    <h1 id="content-heading">Git进阶教程</h1>
</div>
<div id="niu2-left-container" class="col-md-6 col-md-offset-2 with-right-border">
    <div id="niu2-main-content">
        <p>Git的常用命令和场景可参考<a href="/note/git-quick_reference.html">Git快速使用指南</a>，在这里介绍进一步的使用和部分生僻的命令。</p>
<h2 id="f6e15aeb6da6c189999d9402dbc20f73">Git概念和技巧</h2>
<h3 id="9a7323cd6040d03af6e25aabd17523cb">Index vs. Working tree</h3>
<p>使用git reset命令的时候不容易搞懂Index和Working tree这两个概念，下面简要总结一下。</p>
<p><img alt="git index &amp; working tree" src="/static/images/note/git-index-working-tree.png" /></p>
<p>(图片取自stackoverflow上的一个<a href="http://stackoverflow.com/questions/3689838/difference-between-head-working-tree-index-in-git">回答</a>，来源未知)</p>
<h4 id="822135d78e28a0ecc0809c65ff250c98">Git index</h4>
<p>有时候也被称作Staging area和Cache，git add等命令会将文件改动暂存在index中(.git/index)，运行git status后，列在Changes to be committed后面的改动都位于index上。</p>
<p>Git index中的改动可以用git commit提交到本地仓库中。</p>
<h4 id="811a411fb61cc196932aa936ec2618b7">Git working tree</h4>
<p>也被称作Working directory，git add之前的文件改动都是在working tree中进行的，运行git status后，列在Changes not staged for commit和Untracked files后面的改动都位于working tree上。</p>
<h2 id="2d371ffa3af8ee7067b7a5667cb0631a">Git进阶使用场景</h2>
<p>并不常见的使用场景。</p>
<h3 id="8815b4b8bd8030ec6e086ad5ff8be393">git reset</h3>
<h4 id="935241c614b974c53e00fe4215647bc4">git reset --soft</h4>
<p>既没修改index也没修改working tree，只是将当前HEAD指针放到ORIG_HEAD里，然后将HEAD指向目标Commit(默认为HEAD)。</p>
<p>如果要撤销<code>git reset --soft</code>，只需要使用<code>git reflog</code>找到最近的一次提交，然后对其再做一次reset即可，比如<code>git reset --soft HEAD@{0}</code>。</p>
<h4 id="4d3c3f1ace073df8b1e9ea7ea9f8f0d2">git reset --mixed</h4>
<p>重置index，不修改working tree。通常用于将git add的改动移出index，不会修改文件内容。</p>
<h4 id="71b93dd8c72085dfbe9095f98afbc23e">git reset --hard</h4>
<p>重置index和working tree，完全恢复到目标comit(默认是HEAD)的状态。所有未commit或stash的改动都会<strong>丢失</strong>，使用此命令需多加小心。</p>
<h3 id="e4957d67a30d247d93e2464f23386d55">detached HEAD state</h3>
<p>有时需要返回之前的提交状态，此时会处于“detached head“状态。</p>
<div class="codehilite"><pre>mkdir git-test &amp;&amp; cd $_ &amp;&amp; git init  # 初始化一个新的git仓库
touch a.txt &amp;&amp; git add $_ &amp;&amp; git commit -m &quot;first commit&quot;   # 添加文件a.txt并提交
touch b.txt &amp;&amp; git add $_ &amp;&amp; git commit -m &quot;second commit&quot;  # 添加文件b.txt并提交
git log --oneline  # 查看提交日志
# 输出如下(##开头)
## 8083b9e second commit
## 15b7a79 first commit
git branch         # 查看分支情况
# 输出如下(##开头)
## * master
# 现在签出first commit
git checkout 15b7a79
# 输出如下(##开头)
## Note: checking out &#39;15b7a79&#39;.
## You are in &#39;detached HEAD&#39; state.
## ...
</pre></div>


<p>此时即处于detached head状态，当前的文件回到first commit后的样子。</p>
<div class="codehilite"><pre>git branch
# 输出如下所示(##开头)
## * (no branch)
## master
</pre></div>


<p>最后，可以用如下命令回到second commit状态。
    git checkout master</p>
<h2 id="2f512eb7196fc80e791fe1454bb7782a">Git生僻命令</h2>
<h3 id="a8c76dd2df2d15cd9473a72ea89ec739">git fsck</h3>
<p>检查git对象是否有效和能否被链接到。</p>
<p>使用<code>git fsck</code>的一个例子是，当不小心drop或clear了stash列表时，可以这样找回(代码取自stackoverflow上的一个<a href="http://stackoverflow.com/questions/89332/recover-dropped-stash-in-git">回答</a>):</p>
<div class="codehilite"><pre>for ref in `git fsck --unreachable | grep commit | cut -d&#39; &#39; -f3`; do git show --summary $ref; done | less
</pre></div>


<p><code>git fsck</code>的速度会比较慢，上面的命令会列出比较多的commit，因为<code>git stash</code>的默认提交信息都是<code>WIP on ...</code>，所以根据提交信息即可找到丢失的stash提交。</p>
<h3 id="775f3c99fedaec0458b8eb087265d9ae">git reflog</h3>
<p>记录了HEAD指针的完整改动历史，通常用于于查找“丢失”的commit和跨分支查看提交历史。当因为某些操作导致某些commit“丢失”时，可以使用<code>git reflog</code>配合<code>git reset --hard</code>来恢复到之前的提交状态。</p>
<h3 id="20147e790d323c59e511dd69f9f20158">git rev-list</h3>
<p>按时间逆序列出提交对象，常用于查找涉及到某些文件的提交的hash。例如，查找所有关系到文件readme的提交：</p>
<div class="codehilite"><pre>git rev-list HEAD -- readme
</pre></div>


<p>更多功能参考<code>man git-rev-list</code>。</p>
<h3 id="5c874c8cf8e423d943d9fcf1bb20f4dd">git rebase</h3>
<p>rebase操作可以将一个分支上的提交合并到另一个分支上，和merge操作不同的是，rebase最后形成线性的历史。</p>
<h4 id="1bbbb204023e59eba03319c7c5848fd1">注意事项</h4>
<p>使用git rebase需要注意的一点就是<strong>不要rebase已经提交到远程仓库的代码</strong>。</p>
<h4 id="20f69ff6588b2c95c5d2f617ecae2c31">pull request</h4>
<p>向远程仓库提交pull-request之前，先在自己的分支上rebase一下</p>
<div class="codehilite"><pre>git rebase master
</pre></div>


<p>这样仓库管理员在merge你的pull-request时就可以直接快进，而不用解决冲突了。</p>
<h4 id="0c70f60bcf1c57a3c314a7bc90919c5b">撤销rebase</h4>
<p>需要撤销rebase引入的变更时，比较简便的方法是使用git reflog。首先通过<code>git reflog</code>和<code>git log HEAD@{XX}</code>找到恢复点，然后使用git reset --hard。如果rebase之后还没有做过其他会变更提交历史的git操作，直接执行<code>git reset --hard ORIG_HEAD</code>即可。</p>
<p>举例说明，假设master分支的提交记录如下（<code>#</code>后为注释内容）：</p>
<div class="codehilite"><pre>* 2014-02-19 0101db8 update a3 # A2
* 2014-02-19 6a741e8 update a2 # A1
* 2014-02-19 d2e4ed4 update a  # A
* 2014-02-19 f4d5abd init
</pre></div>


<p>test分支的提交记录如下：</p>
<div class="codehilite"><pre>* 2014-02-19 82137d8 update b3 # B2
* 2014-02-19 74bfa49 update b2 # B1
* 2014-02-19 d2e4ed4 update a  # A
* 2014-02-19 f4d5abd init
</pre></div>


<p>直观的分支图如下：</p>
<div class="codehilite"><pre>A--A1--A2 (分支master)
 \
  \B1--B2 (分支test)
</pre></div>


<p>现在执行命令<code>git rebase test^1 master</code><sup id="fnref:1"><a class="footnote-ref" href="#fn:1" rel="footnote">1</a></sup>，则分支图变为:</p>
<div class="codehilite"><pre>A--B1--A1&#39;--A2&#39; (分支master)
 \
  \B1--B2       (分支test)
</pre></div>


<p>如果想撤销rebase操作，执行<code>get reflog</code>输出如下（节选）：</p>
<div class="codehilite"><pre>691342e HEAD@{3}: rebase finished: returning to refs/heads/master
691342e HEAD@{4}: rebase: update a3
1ce3d6a HEAD@{5}: rebase: update a2
74bfa49 HEAD@{6}: checkout: moving from test to 74bfa49cadc0bf53bd471e330e3c769509018c74^0
0101db8 HEAD@{7}: reset: moving to HEAD^
</pre></div>


<p>上面的日志中，HEAD@{3} ~ HEAD@{6}属于rebase操作，我们要做的就是找到rebase操作前的那个提交，然后执行</p>
<div class="codehilite"><pre>git log HEAD@{7}           # 查看日志以确认是正确的恢复点
git reset --hard HEAD@{7}  # 撤销rebase操作
</pre></div>


<h2 id="81f5d554d30e82d475ed29a45a7c4277">阅读资料</h2>
<ul>
<li><a href="http://alblue.bandlem.com/2011/08/git-tip-of-week-detached-heads.html">Git Tip of the Week: Detached Heads</a></li>
</ul>
<div class="footnote">
<hr />
<ol>
<li id="fn:1">
<p>test^1表示仅rebase到提交B1&#160;<a class="footnote-backref" href="#fnref:1" rev="footnote" title="Jump back to footnote 1 in the text">&#8617;</a></p>
</li>
</ol>
</div>
    </div>
    <div id="content-comments">
<!-- Duoshuo Comment BEGIN -->
<div class="ds-thread"></div>
<script type="text/javascript">var duoshuoQuery={short_name:"vic-story"};(function(){var a=document.createElement("script");a.type="text/javascript";a.async=true;a.src=(document.location.protocol=="https:"?"https:":"http:")+"//static.duoshuo.com/embed.js";a.charset="UTF-8";(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(a)})();</script>
<!-- Duoshuo Comment END --></div>

</div>
<div class="niu2-right-container col-md-2">
    <div id="niu2-sidebar-meta" class="niu2-sidebar">
        <div class="niu2-sidebar-label"><i class="fa fa-calendar"></i>发布时间:</div>
        <div class="niu2-sidebar-value">2013-08-25 12:14</div>
        <div class="niu2-sidebar-label"><i class="fa fa-pencil" style="font-size: 1.05em;"></i>最后修改:</div>
        <div class="niu2-sidebar-value">2014-03-03 16:43</div>
        <div class="niu2-sidebar-label"><i class="fa fa-book"></i>分类:</div>
        <div class="niu2-sidebar-value"><a href="http://www.zhuimengle.com/note/index.html">印象-笔记</a></div>
        <div class="niu2-sidebar-label"><i class="fa fa-tag"></i>标签:</div>
 
            <div class="niu2-sidebar-inter-value niu2-sidebar-tag"><a href="http://www.zhuimengle.com/tag/git.html">git</a><sup>6</sup></div>
            <div class="niu2-sidebar-inter-value niu2-sidebar-tag"><a href="http://www.zhuimengle.com/tag/jiao-cheng.html">教程</a><sup>13</sup></div>
    </div>
</div>

<div class="niu2-right-container col-md-3">
    <div id="niu2-sidebar-toc" class="niu2-sidebar" data-status="closed">
        <div class="niu2-sidebar-label">
            <i id="niu2-sidebar-toc-ctrl" class="fa fa-plus"></i>目录
        </div>
        <ol id="niu2-sidebar-toc-list">
            <li><a href="#content-heading">Git进阶教程</a></li>
            <li><a href='#f6e15aeb6da6c189999d9402dbc20f73'>Git概念和技巧</a><ol><li><a href='#9a7323cd6040d03af6e25aabd17523cb'>Index vs. Working tree</a><ol><li><a href='#822135d78e28a0ecc0809c65ff250c98'>Git index</a></li><li><a href='#811a411fb61cc196932aa936ec2618b7'>Git working tree</a></li></ol></li></ol></li><li><a href='#2d371ffa3af8ee7067b7a5667cb0631a'>Git进阶使用场景</a><ol><li><a href='#8815b4b8bd8030ec6e086ad5ff8be393'>git reset</a><ol><li><a href='#935241c614b974c53e00fe4215647bc4'>git reset --soft</a></li><li><a href='#4d3c3f1ace073df8b1e9ea7ea9f8f0d2'>git reset --mixed</a></li><li><a href='#71b93dd8c72085dfbe9095f98afbc23e'>git reset --hard</a></li></ol></li><li><a href='#e4957d67a30d247d93e2464f23386d55'>detached HEAD state</a></li></ol></li><li><a href='#2f512eb7196fc80e791fe1454bb7782a'>Git生僻命令</a><ol><li><a href='#a8c76dd2df2d15cd9473a72ea89ec739'>git fsck</a></li><li><a href='#775f3c99fedaec0458b8eb087265d9ae'>git reflog</a></li><li><a href='#20147e790d323c59e511dd69f9f20158'>git rev-list</a></li><li><a href='#5c874c8cf8e423d943d9fcf1bb20f4dd'>git rebase</a><ol><li><a href='#1bbbb204023e59eba03319c7c5848fd1'>注意事项</a></li><li><a href='#20f69ff6588b2c95c5d2f617ecae2c31'>pull request</a></li><li><a href='#0c70f60bcf1c57a3c314a7bc90919c5b'>撤销rebase</a></li></ol></li></ol></li><li><a href='#81f5d554d30e82d475ed29a45a7c4277'>阅读资料</a></li>
            <li><a href="#content-comments">评论</a></li>
        </ol>
    </div>
</div>
    </div>

    <div id="body-footer" class="col-md-6 col-md-offset-2">
<div class="niu2-footer">
    <hr/>
	<p>
		Powered by <a href="https://github.com/getpelican/pelican">Pelican</a>, 
        <a href="https://github.com/mawenbao/niu-x2-sidebar">theme</a> built with <a href="http://getbootstrap.com">Bootstrap3</a>
		by <a href="http://blog.atime.me">Ma Wenbao</a>, icons by 
		<a href="http://fortawesome.github.io/Font-Awesome">Font Awesome</a>.
	</p>
	<p>
		©
				2009-2014
		<a class="niu2-footer-link" href="http://www.zhuimengle.com">vk</a>
    </p>
    <p class="niu2-icons">
	        <a class="niu2-footer-icon" href="/my_gnupg.html" title="my public key">
	            <i class="fa fa-key fa-lg"></i>
	        </a>
	        <a class="niu2-footer-icon" href="V: dolphinzhang1987@gmail.com" title="my email address">
	            <i class="fa fa-envelope-o fa-lg"></i>
	        </a>
	        <a class="niu2-footer-icon" href="https://github.com/vickyi" title="my github page">
	            <i class="fa fa-github-alt fa-lg"></i>
	        </a>
	        <a class="niu2-footer-icon" href="/feed.xml" title="subscribe my blog">
	            <i class="fa fa-rss fa-lg"></i>
	        </a>
	</p>
</div>    </div>
    
    <div id="niu2-pygments" data-theme="github"></div>

    <script type="text/javascript" src="//ajax.aspnetcdn.com/ajax/jQuery/jquery-1.11.0.min.js"></script>
    <script type="text/javascript" src="http://www.zhuimengle.com/theme/js/niu2.min.js"></script>
    <script type="text/javascript" src="http://www.zhuimengle.com/theme/js/bootstrap.min.js"></script>
    <script type="text/javascript">onContentLoaded();</script>
  </body>
</html>